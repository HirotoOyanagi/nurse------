# ナーススケジューリング問題に対するペナルティを用いた局所探索法

## 1. はじめに

病棟看護業務に当たるナースの勤務表を作成する問題は、ナーススケジューリング問題（Nurse Scheduling Problem: 以下、NSP）と呼ばれる。このNSPは、法律で求められる勤務形態を守り、各ナースの負担などを十分に考慮しながら、各日のシフトの必要人数を満たすなど、多くの制約が課された複雑な組み合わせ最適化問題である[1]。

制約として、満足されなければスケジュールとして成立しないハード制約と、可能なら満足させたいソフト条件が与えられる。これらの制約を満たさなくてはならない勤務表の作成には、看護師長などの多忙なスタッフがかなりの時間を割いているのが実情であり[2]、その負担軽減のためにも自動化が強く求められている。

本稿では、1人のナースの1日の割り当てをシフトと呼び、休日以外のシフトをまとめて勤務シフトと呼ぶ。また、1人分の全日程のシフトの集合をスケジュールと呼び、出力する表全体（全員のスケジュールの集合）を勤務表と呼ぶ。

### 表1 ナース5人、1週間の勤務表の例（日:日勤、夜:夜勤、-:休日）

| ナース | 月(1) | 火(2) | 水(3) | 木(4) | 金(5) | 土(6) | 日(7) |
|--------|-------|-------|-------|-------|-------|-------|-------|
| ナースA | 日 | 日 | - | 夜 | 夜 | - | - |
| ナースB | 夜 | 夜 | - | 日 | 日 | - | - |
| ナースC | - | - | - | 日 | 日 | 夜 | 夜 |
| ナースD | - | 夜 | 夜 | - | - | 日 | 日 |
| ナースE | 日 | 日 | 日 | - | - | 日 | 日 |

NSPの解法には2つのアプローチがある。

1. **厳密解法**: 整数計画問題や制約充足問題などの標準問題に定式化することで解く手法[3]。最近の研究では、列生成法を用いた手法[4]、看護する側（ナース）と看護される側（患者）を同時に考慮して、0-1整数計画問題として解く手法[5]などがある。

2. **ヒューリスティックス**: 焼きなまし法や遺伝的アルゴリズムなどを問題特有の性質に合わせて利用するアプローチ[3]。最近の研究では、ナース間の負荷分散を考慮した勤務表を立案する遺伝的アルゴリズムを用いた手法[6]、さらに、ナース間の相性を追加で考慮した手法[7]などがある。

本稿では、汎用ソルバーを用いた厳密解法より速く解を出力することを目的とし、ペナルティを用いた局所探索法と動的計画法に基づくアルゴリズムを提案する。

### 本稿の構成

- 第2節では、NSPの組み合わせ最適化問題としての問題定義や、本論文で扱う表記や評価関数についての諸定義を行う
- 第3節では、提案手法を2つ説明する
- 第4節では、計算機実験の結果と考察を述べる
- 第5節では、本稿のまとめと今後の課題について述べる

## 2. 準備

### 2.1 問題の定義

NSPは任意の計画期間（D日間）に渡る、ナースN人の勤務表を立案する問題である。NSPでは、制約条件として、ハード制約とソフト制約が与えられる。

- **ハード制約**: 勤務表を作成する際、絶対に満たさなければならない制約
- **ソフト制約**: 絶対に満たす必要はないが、制約を満たせなかった場合に違反点数が発生する制約

ソフト制約による違反点数の合計を評価値とし、これを最小にするような勤務表を出力することを目的とする。

- **入力**: 計画期間、ナースの人数、さまざまな制約条件（次節で言及）
- **出力**: D日間、N人のナースに対する勤務表
- **最小化（目的関数）**: ソフト制約による違反点数の合計

### 2.2 制約

本研究は、ナーススケジューリング問題の制約として、公開されているベンチマーク[8]に準拠したものを用いる。

- シフトの種類は2～4、スケジュール期間とナースの人数は任意

#### ハード制約（絶対に満たさなければいけない制約）

- 勤務表立案期間中、全てのナースの全ての日に1つのシフトが与えられる
- **シフトローテーション**: 前日の勤務シフトに続くことができない勤務シフト
- **最大勤務シフト数**: 各従業員に割り当てることができる各勤務シフトの最大数
- **最大合計時間**: 各ナースに割り当てることができる合計時間
- **最小合計時間**: 各ナースに割り当てなければならない最小合計時間
- **最大連続勤務シフト数**: 休みを取る前に働くことができる連続シフトの最大数
- **最小連続勤務シフト数**: 休みを取る前に働かなければならない勤務シフトの最小数
- **最小連続休日**: 勤務シフトを割り当てる前に、割り当てなければならない連続休日の最小数
- **週末の最大数**: 勤務シフトを割り当てることができる週末の最大数（週末は、土曜日と日曜日のいずれか一方あるいは両方に勤務シフトがある場合、勤務していると定義される）
- **指定休日**: 各ナースは休日を指定できる

#### ソフト制約（満たさない場合、違反点数が発生する制約）

- **勤務シフト総数**: 各日の各勤務シフトにおいて必要人数が決まっており、人数の過不足に応じたペナルティが与えられる（以降、この制約を人数制約と呼ぶ）
- **シフトオンリクエスト**: ナースからリクエストされる指定された日の勤務シフトの希望
- **シフトオフリクエスト**: ナースからリクエストされる指定された日の休日希望

### 2.3 評価関数

前項で言及した、ソフト制約による違反点数が評価値である。ハード制約を満たしつつ、評価値が最小になるような勤務表を出力する。

評価関数とパラメータは以下のようになる：

$$S = \sum_{t=1}^{T} \sum_{d=1}^{D} \max\left(100 \cdot \frac{(C_{dt} - D_{dt})}{D_{dt}}, C_{dt} - D_{dt}\right) + \sum_{n=1}^{N} \sum_{d=1}^{D} \left(W^+_{nd} \cdot R^+_{nd} + W^-_{nd} \cdot R^-_{nd}\right)$$

- **T**: 勤務シフトの種類数
- **C_{dt}**: d日目の勤務シフトtにおいて必要な人数
- **D_{dt}**: 実際に、d日目の勤務シフトtに割り当てられているナースの人数
- **R^+_{nd}**: 希望した日に希望した勤務シフトに入れたかどうかの0-1変数（入れた場合と希望していない場合0、入れなかった場合1）
- **R^-_{nd}**: 希望した日に休日が取れたかどうかの0-1変数（休日が取れた場合と希望していない場合0、取れなかった場合1）
- **W^+_{nd}**: 希望した日に希望した勤務シフトに入れなかった場合に発生する違反点数
- **W^-_{nd}**: 希望した日に休日が取れなかった場合に発生する違反点数

## 3. 提案手法

本節では、提案手法のアルゴリズムについて述べる。提案手法は局所探索に基づくものであり、近傍はある1人分のスケジュールを変更することで得られるものとする。

探索においては、人数制約に対しペナルティという変数を保持し、本来の目的関数にペナルティを加えた状態で最適解の探索を行う。すなわち、近傍の探索においては、N人のうち、N-1人のスケジュールが固定された状態で、残り1人だけについて最適解を得る。これは動的計画法により多項式時間で実行可能である。

ペナルティは解のソフト制約違反に従って少しずつ変更する。すなわち、探索時にN-1人の各日の各シフト割り当てが勤務シフト総数に足りていなければ、ペナルティを大きくする。足りていれば、ペナルティを小さくする。

ペナルティに対応する変数は「シフト評価テーブル」で保持する。「シフト評価テーブル」とは、1人のスケジュールを決定するために、固定された他のN-1人のスケジュールに沿って、各日の各シフトに点数をつけた表のことである。次にスケジュールを決定するナースは、このシフト評価テーブルの点数の合計が最大となるようにスケジュールを決定する。

### 表2 7日間のシフト評価テーブルの例

| シフト | 月(1) | 火(2) | 水(3) | 木(4) | 金(5) | 土(6) | 日(7) |
|--------|-------|-------|-------|-------|-------|-------|-------|
| 休日 | -40 | 0 | 100 | -30 | -10 | -100 | -100 |
| 日勤 | 110 | 150 | 10 | 150 | 130 | 270 | 90 |
| 夜勤 | 220 | 160 | 210 | 70 | 0 | 180 | 230 |

例えば、月曜の夜勤のペナルティが220となっているが、これは暫定解において夜勤の人数が少ないため増やさなければいけないことを意味している。また、土曜日の休日が-100となっているのは、休日のシフトの人数が多すぎるため減らさなければいけないことを意味する。

### 提案手法の手順

1. ハード制約を満たしたうえでランダムに勤務表の初期値を決める
2. ハード制約を満たす遷移グラフ作成
3. 固定されたN-1人のスケジュールに従い、シフト評価テーブルに点をつける
4. 各日の各シフトのペナルティを更新し、シフト評価テーブルに加える
5. 遷移グラフに沿って、シフト評価テーブルから合計点が最大になるようにシフトを選択し、ナース1人分のスケジュールを決める
6. 3～5をN人分行い、違反点数の大きいソフト制約の勤務シフト総数による違反点数を数える
7. 違反点数の最小値が5回連続で更新されなければ、この時点で違反点数が最小となる勤務表を出力して終了。そうでなければ、3～6を繰り返す

### 3.1 シフト評価テーブルの更新

シフト評価テーブルの更新は2段階で行われる。

#### フェーズ1: 勤務表を参照して値を振る

次に更新するナースのスケジュールを除いた、N-1人のスケジュールから、次のようにシフト評価テーブルに値を振る：

- C_{dt} < D_{dt}の場合: 50 × (C_{dt} - D_{dt})
- C_{dt} = D_{dt}の場合: 50

#### フェーズ2: ペナルティの更新

次に更新するナースのスケジュールを除いた、N-1人のスケジュールから、各日の各シフトのペナルティを更新し、シフト評価テーブルに加える：

- C_{dt} ≤ D_{dt}かつP_{dt} > 0の場合: P_{dt} = P_{dt} - 1とし、シフト評価テーブルの対応する箇所に10 × P_{dt}を加える
- C_{dt} > D_{dt}の場合: P_{dt} = P_{dt} + 1とし、シフト評価テーブルの対応する箇所に10 × P_{dt}を加える

#### パラメータ定義

- **T**: シフトの種類数
- **C_{dt}**: d日目のシフトtにおいて必要な人数
- **D_{dt}**: 実際に、d日目のシフトtに割り当てられているナースの人数
- **P_{dt}**: d日目のシフトtに与えられているペナルティ

#### 提案手法の違い

- **提案手法1**: ペナルティの初期値P_{dt} = 5
- **提案手法2**: 0～10のランダムな値を各日の各シフトのペナルティに振り、初期値とした

## 4. 計算機実験

本節では、2つの提案手法の有効性を検証するために計算機実験を行う。提案手法との比較として、汎用ソルバーとして公開されているSCIP[9]で出力した解を用いる。ベンチマーク問題の入力を整数計画問題に変換し、SCIPに解かせた。その結果、今回扱うインスタンスに対して、すでに公開されている最適解と同じ値を出力した。

### 4.1 実験環境

- **CPU**: AMD Ryzen(TM) 7 5825U with Radeon Graphics 2.00 GHz
- **OS**: Windows(TM) 11 Pro
- **メモリ**: 16.0 GB (15.3 GB 使用可能)
- **使用言語**: Java version "17.0.4.1"

### 4.2 入力データ

Nurse Rostering Benchmark Instances[8]というベンチマーク問題を入力とする。本研究ではそれらの中から、最適解が公開されているもののうち、Instance1～Instance5を使用する。

### 4.3 実験条件

提案手法1と2に対して、先に示したベンチマーク問題の各インスタンスに対し10回ずつ実験を行い、評価値と実行時間を記録する。

### 4.4 実験結果

Instance1～5に対し、SCIPと提案手法の計3個の計測結果を表3に示す。（提案手法の提案手法1と2の評価値と実行時間は、10回の計測の平均値である。）

### 表3 実験結果

| インスタンス | SCIP | | 提案手法1 | | 提案手法2 | |
|-------------|------|------|----------|------|----------|------|
| | 評価値 | 時間[sec] | 評価値 | 時間[sec] | 評価値 | 時間[sec] |
| instance1 | 607.0 | 1.00 | 618.0 | 0.02 | 617.8 | 0.02 |
| instance2 | 828.0 | 7.00 | 1074.7 | 0.38 | 1102.7 | 0.38 |
| instance3 | 1001.0 | 46.00 | 2480.9 | 0.21 | 2480.3 | 0.21 |
| instance4 | 1716.0 | 171.00 | 2063.4 | 384.08 | 2072.3 | 310.06 |
| instance5 | 1143.0 | 1371.00 | 1626.6 | 318.44 | 1715.9 | 286.51 |

